{% extends "base.html" %}

{% block title %}{% if scale %}Редактировать{% else %}Создать{% endif %} оценочную шкалу{% endblock %}

{% block content %}
<!-- Header -->
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{{ url_for('admin.dashboard') }}">Админ-панель</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{{ url_for('admin.standards') }}">Нормативы</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{{ url_for('admin.standard_scales') }}">Оценочные шкалы</a>
                </li>
                <li class="breadcrumb-item active">
                    {% if scale %}Редактировать{% else %}Создать{% endif %}
                </li>
            </ol>
        </nav>
        
        <h2 class="mb-0">
            <i class="bi bi-sliders text-primary me-2"></i>
            {% if scale %}Редактировать оценочную шкалу{% else %}Новая оценочная шкала{% endif %}
        </h2>
    </div>
</div>

<!-- Form Card -->
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-3 p-md-4">
                <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <!-- Standard Selection -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-8">
                            <label for="standard_id" class="form-label">
                                <i class="bi bi-stopwatch me-1"></i>
                                Норматив <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" 
                                    id="standard_id" 
                                    name="standard_id" 
                                    required 
                                    onchange="updateStandardInfo(this)">
                                <option value="">-- Выберите норматив --</option>
                                {% for standard in standards %}
                                <option value="{{ standard.id }}" 
                                        data-unit="{{ standard.unit }}"
                                        data-gender-specific="{{ standard.gender_specific }}"
                                        data-lower-is-better="{{ standard.lower_is_better }}"
                                        {% if scale and scale.standard_id == standard.id %}selected{% endif %}>
                                    {{ standard.name }} - {{ standard.theme.module.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="gender" class="form-label">
                                <i class="bi bi-gender-ambiguous me-1"></i>
                                Пол
                            </label>
                            <select class="form-select" id="gender" name="gender">
                                <option value="">-- Унисекс --</option>
                                <option value="M" {% if scale and scale.gender == 'M' %}selected{% endif %}>Мужской</option>
                                <option value="F" {% if scale and scale.gender == 'F' %}selected{% endif %}>Женский</option>
                            </select>
                            <div class="form-text" id="genderHelp">
                                Выберите, если норматив гендерно-специфичный
                            </div>
                        </div>
                    </div>
                    
                    <!-- Info Alert -->
                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle me-2"></i>
                        <div id="standardInfo">
                            Выберите норматив, чтобы увидеть информацию
                        </div>
                    </div>
                    
                    <!-- Scoring Table -->
                    <div class="table-responsive mb-4">
                        <table class="table table-bordered">
                            <thead class="table-light">
                                <tr class="text-center">
                                    <th width="15%">Балл</th>
                                    <th width="25%">Результат <span class="text-danger">*</span></th>
                                    <th>Описание</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="text-center align-middle">
                                        <strong class="text-success fs-5">5</strong>
                                    </td>
                                    <td>
                                        <div class="input-group">
                                            <input type="number" 
                                                   class="form-control" 
                                                   name="value_5" 
                                                   step="0.01"
                                                   placeholder="0.00"
                                                   value="{{ scale.value_5 if scale else '' }}"
                                                   required>
                                            <span class="input-group-text" id="unit5">-</span>
                                        </div>
                                    </td>
                                    <td class="text-muted small align-middle">Отлично</td>
                                </tr>
                                <tr>
                                    <td class="text-center align-middle">
                                        <strong class="text-info fs-5">4</strong>
                                    </td>
                                    <td>
                                        <div class="input-group">
                                            <input type="number" 
                                                   class="form-control" 
                                                   name="value_4" 
                                                   step="0.01"
                                                   placeholder="0.00"
                                                   value="{{ scale.value_4 if scale else '' }}"
                                                   required>
                                            <span class="input-group-text" id="unit4">-</span>
                                        </div>
                                    </td>
                                    <td class="text-muted small align-middle">Хорошо</td>
                                </tr>
                                <tr>
                                    <td class="text-center align-middle">
                                        <strong class="text-warning fs-5">3</strong>
                                    </td>
                                    <td>
                                        <div class="input-group">
                                            <input type="number" 
                                                   class="form-control" 
                                                   name="value_3" 
                                                   step="0.01"
                                                   placeholder="0.00"
                                                   value="{{ scale.value_3 if scale else '' }}"
                                                   required>
                                            <span class="input-group-text" id="unit3">-</span>
                                        </div>
                                    </td>
                                    <td class="text-muted small align-middle">Удовлетворительно</td>
                                </tr>
                                <tr>
                                    <td class="text-center align-middle">
                                        <strong class="text-danger fs-5">2</strong>
                                    </td>
                                    <td>
                                        <div class="input-group">
                                            <input type="number" 
                                                   class="form-control" 
                                                   name="value_2" 
                                                   step="0.01"
                                                   placeholder="0.00"
                                                   value="{{ scale.value_2 if scale else '' }}"
                                                   required>
                                            <span class="input-group-text" id="unit2">-</span>
                                        </div>
                                    </td>
                                    <td class="text-muted small align-middle">Неудовлетворительно</td>
                                </tr>
                                <tr>
                                    <td class="text-center align-middle">
                                        <strong class="text-secondary fs-5">1</strong>
                                    </td>
                                    <td>
                                        <div class="input-group">
                                            <input type="number" 
                                                   class="form-control" 
                                                   name="value_1" 
                                                   step="0.01"
                                                   placeholder="0.00"
                                                   value="{{ scale.value_1 if scale else '' }}"
                                                   required>
                                            <span class="input-group-text" id="unit1">-</span>
                                        </div>
                                    </td>
                                    <td class="text-muted small align-middle">Слабо</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                        <a href="{{ url_for('admin.standard_scales') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-1"></i>
                            Отмена
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>
                            {% if scale %}Сохранить{% else %}Создать{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function updateStandardInfo(select) {
    const option = select.options[select.selectedIndex];
    const unit = option.dataset.unit || '-';
    const genderSpecific = option.dataset.genderSpecific === 'True';
    const lowerIsBetter = option.dataset.lowerIsBetter === 'True';
    
    // Update unit labels
    for (let i = 1; i <= 5; i++) {
        document.getElementById(`unit${i}`).textContent = unit;
    }
    
    // Update info
    const infoDiv = document.getElementById('standardInfo');
    if (unit !== '-') {
        let info = `<strong>Единица измерения:</strong> ${unit}<br>`;
        info += `<strong>Гендерно-специфичный:</strong> ${genderSpecific ? 'Да (нужно создать шкалы для М и Ж отдельно)' : 'Нет'}<br>`;
        info += `<strong>Оценка:</strong> ${lowerIsBetter ? 'Меньше значение = лучше (например, время)' : 'Больше значение = лучше (например, дальность)'}`;
        infoDiv.innerHTML = info;
        
        // Enable/disable gender select
        const genderSelect = document.getElementById('gender');
        const genderHelp = document.getElementById('genderHelp');
        if (genderSpecific) {
            genderSelect.required = true;
            genderHelp.textContent = 'Обязательно выберите пол для этого норматива';
            genderHelp.classList.add('text-danger');
        } else {
            genderSelect.required = false;
            genderHelp.textContent = 'Выберите, если норматив гендерно-специфичный';
            genderHelp.classList.remove('text-danger');
        }
    } else {
        infoDiv.textContent = 'Выберите норматив, чтобы увидеть информацию';
    }
}

// Initialize on page load if standard is selected
document.addEventListener('DOMContentLoaded', function() {
    const standardSelect = document.getElementById('standard_id');
    if (standardSelect.value) {
        updateStandardInfo(standardSelect);
    }
});
</script>
{% endblock %}