{% extends "base.html" %}
{% block title %}Индивидуальные задания{% endblock %}
{% block content %}
<div class="container-fluid py-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('student.profile', student_id=student.id) }}">Профиль</a></li>
            <li class="breadcrumb-item active">Индивидуальные задания</li>
        </ol>
    </nav>
    
    <h2 class="mb-4"><i class="bi bi-list-task me-2"></i>Индивидуальные задания</h2>
    
    <!-- Статистика -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <h3>{{ stats.total }}</h3>
                    <p class="text-muted mb-0">Всего заданий</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-info">
                <div class="card-body text-center">
                    <h3>{{ stats.active }}</h3>
                    <p class="text-muted mb-0">Активные</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body text-center">
                    <h3>{{ stats.completed }}</h3>
                    <p class="text-muted mb-0">Выполнено</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <h3>+{{ stats.total_bonus }}</h3>
                    <p class="text-muted mb-0">Бонусные баллы</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Фильтр -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="btn-group" role="group">
                <a href="?status=" class="btn btn-sm btn-{{ 'primary' if not status_filter else 'outline-primary' }}">Все</a>
                <a href="?status=назначено" class="btn btn-sm btn-{{ 'primary' if status_filter == 'назначено' else 'outline-primary' }}">Назначено</a>
                <a href="?status=в_работе" class="btn btn-sm btn-{{ 'primary' if status_filter == 'в_работе' else 'outline-primary' }}">В работе</a>
                <a href="?status=выполнено" class="btn btn-sm btn-{{ 'primary' if status_filter == 'выполнено' else 'outline-primary' }}">Выполнено</a>
                <a href="?status=просрочено" class="btn btn-sm btn-{{ 'primary' if status_filter == 'просрочено' else 'outline-primary' }}">Просрочено</a>
            </div>
        </div>
    </div>
    
    <!-- Список заданий -->
    {% if assignments %}
    <div class="row">
        {% for assignment in assignments %}
        <div class="col-md-6 mb-3">
            {% if assignment.status == 'назначено' %}
                {% set card_class = 'border-info' %}
                {% set header_class = 'bg-info text-white' %}
                {% set badge_class = 'bg-info' %}
            {% elif assignment.status == 'в_работе' %}
                {% set card_class = 'border-primary' %}
                {% set header_class = 'bg-primary text-white' %}
                {% set badge_class = 'bg-primary' %}
            {% elif assignment.status == 'выполнено' %}
                {% set card_class = 'border-success' %}
                {% set header_class = 'bg-success text-white' %}
                {% set badge_class = 'bg-success' %}
            {% elif assignment.status == 'просрочено' %}
                {% set card_class = 'border-danger' %}
                {% set header_class = 'bg-danger text-white' %}
                {% set badge_class = 'bg-danger' %}
            {% else %}
                {% set card_class = 'border-secondary' %}
                {% set header_class = 'bg-secondary text-white' %}
                {% set badge_class = 'bg-secondary' %}
            {% endif %}
            
            <div class="card {{ card_class }} h-100">
                <div class="card-header {{ header_class }}">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">{{ assignment.title }}</h5>
                        <span class="badge {{ badge_class }}">
                            {% if assignment.status == 'назначено' %}Назначено
                            {% elif assignment.status == 'в_работе' %}В работе
                            {% elif assignment.status == 'выполнено' %}Выполнено
                            {% elif assignment.status == 'просрочено' %}Просрочено
                            {% else %}{{ assignment.status|capitalize }}
                            {% endif %}
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <p class="mb-2">
                        <strong>Тип:</strong> 
                        <span class="badge bg-secondary">{{ assignment.type|capitalize }}</span>
                    </p>
                    
                    {% if assignment.description %}
                    <p class="mb-2"><strong>Описание:</strong><br>{{ assignment.description }}</p>
                    {% endif %}
                    
                    <p class="mb-2">
                        <strong>Дедлайн:</strong> {{ assignment.deadline.strftime('%d.%m.%Y') if assignment.deadline else '—' }}
                        
                        {% if assignment.status not in ['выполнено', 'просрочено'] and assignment.deadline %}
                            {% set deadline_date = assignment.deadline if assignment.deadline.__class__.__name__ == 'date' else assignment.deadline.date() %}
                            {% set today = now.date() if now else None %}
                            {% if today and deadline_date %}
                                {% set days_left = (deadline_date - today).days %}
                                {% if days_left <= 3 and days_left >= 0 %}
                                <span class="badge bg-warning text-dark ms-2">
                                    <i class="bi bi-clock"></i> Осталось {{ days_left }} дн.
                                </span>
                                {% elif days_left < 0 %}
                                <span class="badge bg-danger ms-2">
                                    <i class="bi bi-exclamation-triangle"></i> Просрочено
                                </span>
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    </p>
                    
                    {% if assignment.completion_date %}
                    <p class="mb-2">
                        <strong>Дата выполнения:</strong> 
                        {{ assignment.completion_date.strftime('%d.%m.%Y %H:%M') if assignment.completion_date else '—' }}
                    </p>
                    {% endif %}
                    
                    <p class="mb-0">
                        <strong>Бонус:</strong> 
                        <span class="badge bg-warning text-dark">+{{ assignment.bonus_points }} баллов</span>
                    </p>
                    
                    {% if assignment.created_at %}
                    <p class="text-muted small mt-2 mb-0">
                        Назначено: {{ assignment.created_at.strftime('%d.%m.%Y') }}
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card shadow-sm">
        <div class="card-body text-center py-5">
            <i class="bi bi-inbox fs-1 text-muted mb-3"></i>
            <h5 class="text-muted">Нет индивидуальных заданий</h5>
            {% if status_filter %}
            <p class="text-muted">Попробуйте изменить фильтр</p>
            <a href="{{ url_for('student.assignments', student_id=student.id) }}" class="btn btn-outline-primary">
                Показать все задания
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}